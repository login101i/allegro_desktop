Object.freeze({initialize({modulePath:e=".",importFunctionName:t="__import__"}={}){try{self[t]=Function("u","return import(u)")}catch(r){const s=new URL(e,location),n=e=>{URL.revokeObjectURL(e.src),e.remove()};self[t]=e=>new Promise((r,i)=>{const o=new URL(e,s);if(self[t].moduleMap[o])return r(self[t].moduleMap[o]);const a=new Blob([`import * as m from '${o}';`,`${t}.moduleMap['${o}']=m;`],{type:"text/javascript"}),c=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(a),onerror(){i(Error("Failed to import: "+e)),n(c)},onload(){r(self[t].moduleMap[o]),n(c)}});document.head.appendChild(c)}),self[t].moduleMap={}}}}).initialize({modulePath:"https://assets.allegrostatic.com/sc-12453"});const{assign:e,values:t}=Object,{parse:r}=JSON;function s(e){return Array.isArray(e)}function n(e){return"object"==typeof e&&!s(e)&&null!==e}function i(e){return"string"==typeof e}function o(e){return void 0===e}function a(e){return"function"==typeof e}function c(e){return null===e||"object"!=typeof e||0===Object.keys(e).length}function l(e,t){if(null==e)throw"Cannot convert undefined or null to object";return Array.from(e,t)}function d(e,t,r){return e?l(e.querySelectorAll(t),r):[]}function h(e,t){return e?e.querySelector(t):null}function u(e,t){return e.hasAttribute(t)}function p(e,t){return e.getAttribute(t)}function m(e){return p(e,"data-prototype-id")}function g(e){return p(e,"data-box-id")}function b(e){return p(e,"data-box-name")}function f(e){return p(e,"data-civ")}function v(t,r,...s){return e(t.createElement(r),...s)}function y(e=""){return e.includes("/metrum/")}function C(e){return i(e)?e.split("/metrum/")[1].split("/")[0]:""}function E(){}function w(e,t,r){let s;return function(...n){const i=this,o=r&&!s;return clearTimeout(s),s=setTimeout(()=>{s=null,r||e.apply(i,n)},t),o&&e.apply(i,n),s}}function P(e,t,r){const s=r.createEvent("CustomEvent");s.initCustomEvent(t,!0,!0,{}),e.dispatchEvent(s)}function x(e,t){return e.concat(t)}function k(e,t=(()=>!1)){Object.keys(e).forEach(r=>{({}).hasOwnProperty.call(e,r)&&t(r,e[r])&&delete e[r]})}const S=/Version\/[\d.]+.*Safari/,N=/iPhone|iPad|iPod|Android/i,I=e=>(t,r)=>Object.assign({},t,{},e(r)),R=(e,t,r)=>e.addEventListener(t,r);function A(e){return`<link type="text/css" rel="stylesheet" crossorigin="" href="${e}"/>`}function M(e){return e.textContent}const O=e=>e>=200&&e<=204,W=(e,t,s,n)=>{const{status:i,responseText:o}=e,a=t(i),c=(e=>e.split("\n").reduce((e,t)=>{const r=t.indexOf(":"),s=t.substr(0,r).trim().toLowerCase(),n=t.substr(r+1).trim();return s&&(e[s]=e[s]?`${e[s]}, ${n}`:n),e},{}))(e.getAllResponseHeaders());let l={};try{l=r(o)}catch(d){l=o}a?s({status:i,data:l,headers:c}):n({status:i,data:l,message:"Request failed with status code "+i,headers:c})};var T=()=>{let e=null;const t=(t,r,s,{headers:n={},validateStatus:i=O,withCredentials:o=!1,cancelLast:a=!1,onUploadProgress:c})=>{a&&null!==e&&e.abort();const l=((e,t,r,s,n,i)=>{const o=new XMLHttpRequest;return o.open(e,t,!0),Object.keys(s).forEach(e=>{o.setRequestHeader(e,s[e])}),o.withCredentials=n,o.upload&&i&&o.upload.addEventListener("progress",i),o.send(((e,t)=>["POST","PUT","PATCH"].includes(e)?"object"!=typeof t||t instanceof Blob||t instanceof FormData?t:JSON.stringify(t):null)(e,r)),o})(t,r,s,n,o,c);return e=l,((e,t)=>new Promise((r,s)=>{e.readyState===XMLHttpRequest.DONE?W(e,t,r,s):e.onreadystatechange=()=>{e.readyState===XMLHttpRequest.DONE&&(W(e,t,r,s),e.onreadystatechange=null)}}))(l,i).finally(()=>{e=null})};return{request:t,get(e,r={}){return t("GET",e,{},r)},post(e,r,s){return t("POST",e,r,s)},put(e,r,s){return t("PUT",e,r,s)},patch(e,r,s){return t("PATCH",e,r,s)},delete(e,r={}){return t("DELETE",e,{},r)}}};const V=e=>e.opbox||{};class j{constructor({targetWindow:e}={}){this.targetWindow=e}get document(){return this.targetWindow.document}}class B extends Error{constructor(e){super(e),this.message=e,this.name="PageRenderingError"}}class L{constructor({data:e,headers:t}={}){this.data=e,this.headers=t}get valid(){return n(this.data)}}class U{constructor(e={}){this.dataSources=e}resolve(e,t){const{value:r}=e;if("DATA_SOURCE"===e.type){const e=this.dataSources[r];return Object.assign({},e&&e.data&&{[t]:e.data},{},e&&!c(e.metadata)&&{[t+".$meta"]:e.metadata})}return{[t]:r}}}class z{constructor({boxes:e={},boxNameToIdMap:t={},dataSources:r={},meta:s={}}={}){this.boxes=e,this.boxNameToIdMap=t,this.dataSources=r,this.meta=s,this.parameterResolver=new U(this.dataSources)}get resolved(){return{boxes:this.resolvedBoxes,boxNameToIdMap:this.boxNameToIdMap,dataSources:this.dataSources,meta:this.meta}}get resolvedBoxes(){const{pageProperties:t}=this;return function(e=this,t,r){const s={};return Object.keys(e).forEach(n=>{s[n]=t.call(r,e[n],n,e)}),s}(this.boxes,r=>{const s=Object.keys(r).reduce((t,s)=>{const n=this.parameterResolver.resolve(r[s],s);return e(t,n)},{});return e(s,t)})}get pageProperties(){const e={};for(const t in this.meta)0===t.indexOf("$page.")&&(e[t]=this.meta[t]);return e}}function H({href:e},t={}){const r=new URL(e);return r.search=((e,t)=>{const r=new URLSearchParams(e.search);return Object.entries(t).map(([e,t])=>(Array.isArray(t)?(r.delete(e),t.forEach(t=>r.append(e,t))):r.set(e,t),r)),r})(r,t).toString(),r.toString()}function D(e){return e>=200&&e<300||502===e}class F{constructor({targetWindow:e=window,httpClient:t,reportError:r,fragmentRenderCallback:s,boxRenderCallback:n}){this.httpClient=t,this.reportError=r,this.targetWindow=e,this.fragmentRenderCallback=s,this.boxRenderCallback=n,this.render={box:this.renderBox.bind(this),fragment:this.renderFragment.bind(this)}}getPageData(e){const t={headers:{Accept:"application/vnd.opbox-web.v2+json"},cancelLast:!0,validateStatus:D};return this.httpClient.get(e,t).then(e=>{const t=new L(e);if(!t.valid)throw new B("Opbox response is invalid.");return new z(t.data)})}handleError(e){return this.reportError(Error(e)),Promise.reject(e)}renderSubtree({boxId:e,additionalQueryParameters:t={},isPlaceholder:r=!1}={}){return this.targetWindow.console.warn("Warning: renderSubtree method is deprecated and will be removed soon. Use render.box method instead."),this.renderBox({boxId:e,additionalQueryParameters:t,isPlaceholder:r})}renderBox({boxId:e,additionalQueryParameters:t={},isPlaceholder:r=!1}={}){return e?this.httpClient.get(H(this.targetWindow.location,t),{headers:{Accept:"application/vnd.opbox-web.subtree+json","x-box-id":e},cancelLast:!1,validateStatus:D}).then(({data:t})=>this.boxRenderCallback({boxId:e,data:t,isPlaceholder:r})):this.handleError("Missing 'boxId' property!")}renderFragment({pathname:e,additionalQueryParameters:t={}}={}){if(!e)return this.handleError("Missing 'pathname' property!");if(!(e=>!!e.match(/^(\/[a-zA-Z0-9\-]+)*\/{0,1}$/))(e))return this.handleError("Invalid 'pathname' property!");const{protocol:r,host:s}=this.targetWindow.location,{href:n}=new URL(`${r}//${s}${e}`);return this.httpClient.get(H({href:n},t),{headers:{Accept:"application/vnd.opbox-web.subtree+json"},cancelLast:!1,validateStatus:D}).then(({data:t})=>this.fragmentRenderCallback({pathname:e,data:t}))}createAPI(){return{renderSubtree:this.renderSubtree.bind(this),render:this.render}}}class q{constructor({meta:e={}}={},t){this.appContext=t,this.meta=e}updateMetaRobots(){const e=this.appContext.document.querySelector('head meta[name="robots"]');e&&this.meta&&e.setAttribute("content",[this.meta.noindexCondition?"noindex":"index",this.meta.nofollowCondition?"nofollow":"follow"].join(", "))}render(){this.updateMetaRobots()}}class ${constructor({appContext:e,analytics:t,updateComponentCallback:r=E,beforeUpdateComponentCallback:s=E}){this.appContext=e,this.rawData=new z,this.listeners={},this.analytics=t,this.updateComponentCallback=r,this.beforeUpdateComponentCallback=s}registerListener(e,t=E,r=E){if(this.rawData.boxes[e]){const r=this.rawData.resolved.boxes[e];setTimeout(()=>{t(r)},0)}this.listeners[e]={onChange:t,onProgress:r}}triggerChangeListener(e){this.rawData=e;const{boxes:t,boxNameToIdMap:r,meta:s}=this.rawData.resolved,{defaultCustomParams:n}=s;this.analytics&&this.analytics.updateCustomParams(n),Object.entries(t).forEach(([e,t])=>{o(t)||this.updateComponentCallback(e,t)}),Object.keys(r).forEach(e=>{const s=t[r[e]];if(!o(s)){const t=this.listeners[e];t&&a(t.onChange)&&setTimeout(()=>t.onChange(s),0)}}),new q({meta:s},this.appContext).render()}triggerProgressListener(){this.beforeUpdateComponentCallback(),Object.keys(this.listeners).forEach(e=>{const t=this.listeners[e];t&&a(t.onProgress)&&setTimeout(()=>t.onProgress(),0)})}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var _,J=(((e,t)=>{e.exports=(()=>{function e(e){return e instanceof Object&&e.constructor===Object}function t(r,s){var n=r,i=s;e(r)||(n={}),e(s)||(i={});var o=Object.keys(n),a=Object.keys(i),c={};return o.forEach(r=>{-1!==a.indexOf(r)?null===n[r]?c[r]=i[r]:e(n[r])&&e(i[r])?c[r]=t(n[r],i[r]):c[r]=i[r]:c[r]=n[r]}),a.forEach(e=>{-1===o.indexOf(e)&&(c[e]=i[e])}),c}return function(r){var s=r;e(r)||(s={});for(var n=arguments.length,i=Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return i.forEach(r=>{e(r)&&(s=t(s,r))}),s}})()})(_={exports:{}}),_.exports);const X=e=>d(e,"[data-analytics-enabled]"),G=e=>{const t=d(e,"[data-analytics-proxied]").reduce((e,t)=>{const r=X(t).filter(t=>!e.includes(t));return r.length?x(e,r):e},[]);return X(e).filter(e=>!t.includes(e))},K=new WeakMap,Q=new WeakMap,Y=e=>K.has(e),Z=(e,t,r=0)=>{if(!e||Y(e))return;const s=(parseInt(Q.get(e),10)||0)+t;s>=r&&(K.set(e,!0),P(e,"boxView",e.ownerDocument)),Q.set(e,s)},ee=(e,t,r,s)=>e>0?e<r?t<r?t-e:r-e:0:t<0?0:t<r?t:s,te=(e="",t)=>e.slice(0,t);class re{constructor({targetWindow:e,send:t}={}){this.window=e,this.send=t,this.counter=0}handleError({error:e={}}={}){const{name:t,message:r,stack:s}=e;this.counter<100&&(this.counter+=1,this.send({type:t,message:te(r,800),stack:te(s,800)}))}initialize(){R(this.window,"error",this.handleError.bind(this))}}const se=(e,t)=>{const r={};for(let n=0;n<e.attributes.length;n+=1){const i=e.attributes[n];0===i.name.indexOf(t)&&(r[(s=i.name.replace(t,""),s.replace(/^([A-Z])|[\s|_-](\w)/g,(e,t,r)=>r?r.toUpperCase():t.toLowerCase()))]=i.value)}var s;return r},ne=({contextNode:e,customParams:t={}})=>{const r=se(e,"data-analytics-view-opbox-custom-"),s=Object.keys(r).length?{_opbox:r}:{};return J(se(e,"data-analytics-view-custom-"),s,t)},ie=({contextNode:e,coordinates:t={},destinationUrl:r="",customParams:s={},isNewTab:n})=>{const i=n?{isNewTab:n}:{},o=Object.assign({},se(e,"data-analytics-click-opbox-custom-"),{destinationUrl:r},i,{},t);return J(se(e,"data-analytics-click-custom-"),{_opbox:o},s)},oe=({contextNode:e,customParams:t={}})=>{const r=se(e,"data-analytics-interaction-custom-"),s=se(e,"data-analytics-interaction-opbox-custom-"),n=Object.keys(s).length?{_opbox:s}:{};return J(r,n,t)},ae=(e,t,r)=>(R(e,t,r),()=>{e.removeEventListener(t,r)});class ce{constructor({targetWindow:e,config:t,cookieMonsterClient:r,boxViewsMarker:s,sendPerformanceMetrics:n}){const{cookieMonster:{isEngagementMeasuringEnabled:i,isErrorReporterEnabled:o,defaultCustomParams:a={}}={}}=t;this.targetWindow=e,this.document=this.targetWindow.document,this.isEngagementMeasuringEnabled=i,this.isErrorReporterEnabled=o,this.cookieMonsterClient=r,this.boxViewsMarker=s,this.defaultCustomParams=a,this.eventCallbacks=[],this.sendPerformanceMetrics=n||E,this.errorReporter=new re({targetWindow:e,send:this.sendErrorEvent.bind(this)});const c=(({navigator:{userAgent:e=""}={}}={})=>e)(e);this.isMobile=(e=>!!e.match(N))(c),this.isSafari=(e=>!!e.match(S))(c),this.isFirefox=(e=>e.toLowerCase().includes("firefox"))(c)}initialize(){this.cookieMonsterClient.initialize(),this.isEngagementMeasuringEnabled&&__import__("./engagement-observer-b4d27ad4.js").then(({attachEngagementObserver:e})=>{e({targetWindow:this.targetWindow,onCycleComplete:this.sendPingEvent.bind(this)})}),this.isErrorReporterEnabled&&this.errorReporter.initialize(),this.eventHandlers=[ae(this.document,"change",this.handleChange.bind(this)),ae(this.document,"click",this.handleClick.bind(this)),ae(this.document,"mousedown",this.handleLinkClick.bind(this)),ae(this.document,"submit",this.handleSubmit.bind(this)),ae(this.document,"contextmenu",this.handleClick.bind(this)),ae(this.document,"boxView",this.handleBoxView.bind(this)),ae(this.targetWindow,"DOMContentLoaded",this.detectAdblock.bind(this))]}teardown(){this.eventHandlers.forEach(e=>{e()})}callEventCallbacks(e){this.eventCallbacks.length&&this.eventCallbacks.forEach(t=>t(e))}sendEvent({contextNode:e,action:t,label:s="",value:n,customParams:i={}}={}){if(!e||!t)return{};const o=e.closest("[data-analytics-category]").getAttribute("data-analytics-category"),a=b(e.closest("[data-box-name]")),c=e.closest("[data-box-id]"),l=c&&g(c),d=(e=>{const t=e.closest("[data-analytics-tags]");return t?((e,t)=>{const r=e.split(","),s=t.split(","),n=r.concat(s);return n.filter((e,t)=>e&&n.indexOf(e)===t)})(t.closest("[data-item]")?(e=>{const t=e&&e.closest("[data-box-name][data-analytics-tags]");return t&&p(t,"data-analytics-tags")||""})(t):"",p(t,"data-analytics-tags")||""):[]})(e),h=(e=>{const t=e.closest("[data-analytics-groups]");if(t){let e=decodeURIComponent(p(t,"data-analytics-groups"));try{e=r(e)}catch(s){return console.log(`JSON.parse error! Can not convert ${e} to JSON.`),[]}return e}return[]})(e),u=d.length?{analyticsTags:d}:{},m=h.length?{groups:h}:{},f=Object.assign({},u,{},m,{},l?{boxName:a,boxId:l}:{boxName:a}),v={category:o,action:t,label:s,value:n,customParams:J(Object.assign({},i),{_opbox:f},this.defaultCustomParams.ev)};return this.cookieMonsterClient.send("event",v),this.callEventCallbacks(v),v}sendPingEvent({engagementTime:e,scrollBottom:t,pageHeight:r}={}){const s={category:"Engagement",label:"ping",customParams:{et:e,sb:t,ph:r}};this.cookieMonsterClient.send("event",s),this.callEventCallbacks(s)}sendErrorEvent({type:e,message:t,stack:r}={}){const s={category:"BrowserError",label:e,value:t,customParams:{st:r}};this.cookieMonsterClient.send("event",s),this.callEventCallbacks(s)}sendClickEvent(e){this.sendEvent(Object.assign({},e,{action:"click"}))}sendContextmenuEvent(e){this.sendEvent(Object.assign({},e,{action:"contextmenu"}))}sendBoxInteractionEvent(e){this.sendEvent(Object.assign({},e,{action:"boxInteraction"}))}sendItemViewEvent(e){this.sendEvent(Object.assign({},e,{action:"itemView"}))}sendBoxViewEvent(e){this.sendEvent(Object.assign({},e,{action:"boxView"}))}sendFormSubmitEvent(e){this.sendEvent(Object.assign({},e,{action:"submit"}))}detectAdblock(){const e=v(this.document,"div",{innerHTML:"&nbsp;",className:"adsbox"});this.document.body.appendChild(e),this.targetWindow.setTimeout(()=>{const t=0!==e.offsetHeight;this.cookieMonsterClient.send("event",{category:"clearPV",action:t,customParams:this.defaultCustomParams.ev}),this.document.body.removeChild(e)},100)}handleClick(e){this.handleBoxInteraction(e),this.handleLinkClick(e)}handleBoxInteraction(e){if("function"!=typeof e.target.closest)return;const t=e.target.closest("[data-analytics-interaction]");if(!t)return;const r=oe({contextNode:t}),s=p(t,"data-analytics-interaction-label")||"",n=p(t,"data-analytics-interaction-value")||M(t).trim();this.sendBoxInteractionEvent({contextNode:t,label:s,value:n,customParams:r})}shouldHandleBoxInteraction(e){return"mousedown"===e.type&&!this.isMobile&&(this.isSafari||this.isFirefox)&&"select-one"===e.target.type}handleLinkClick(e){if("function"!=typeof e.target.closest)return;if(this.shouldHandleBoxInteraction(e))return void this.handleBoxInteraction(e);const t=e.target.closest("a");if(!t||!u(t,"data-analytics-clickable"))return;const r=p(t,"data-analytics-click-label")||"",s=p(t,"data-analytics-click-value")||M(t).trim(),n="_blank"===p(t,"target"),i=p(t,"href"),o=e.pageX?{pageX:e.pageX,pageY:e.pageY}:{};"click"!==e.type||0!==e.button?"contextmenu"!==e.type?"mousedown"===e.type&&1===e.button&&this.sendClickEvent({contextNode:t,label:r,value:s,customParams:ie({contextNode:t,coordinates:o,destinationUrl:i,isNewTab:!0})}):this.sendContextmenuEvent({contextNode:t,label:r,value:s,customParams:ie({contextNode:t,coordinates:o,destinationUrl:i})}):this.sendClickEvent({contextNode:t,label:r,value:s,customParams:ie({contextNode:t,coordinates:o,destinationUrl:i,isNewTab:n||e.metaKey||e.ctrlKey})})}handleChange(e){const t=e.target;if("select-one"===t.type&&t&&u(t,"data-analytics-selectable")){const{value:e}=t.options[t.selectedIndex],r=se(t,"data-analytics-select-custom-");this.sendEvent({contextNode:t,action:"change",value:e,customParams:r})}}handleSubmit(e){const t=e.target;if(!t||"FORM"!==t.nodeName||!u(t,"data-analytics-submittable"))return;const r=p(t,"action");let s=l(t.elements).filter(e=>e.name).map(e=>({name:e.name,value:e.value})).sort((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase())).map(e=>`${e.name}=${e.value}`).join("&");s=s?"?"+s:"";let n=s?r+s:r;n=encodeURI(n),this.sendFormSubmitEvent({contextNode:t,value:n,label:"submitForm"})}markParentBoxAsVisible(e){const t=e.parentNode&&e.parentNode.closest("[data-analytics-enabled]");this.boxViewsMarker&&t&&!Y(t)&&this.boxViewsMarker.markBoxAsVisible(t,!0)}handleBoxView(e){const t=e.target;if(!t||!u(t,"data-analytics-enabled")||l(t.childNodes).some(e=>e.classList&&e.classList.contains("opbox-fragment")))return;const s=p(t,"data-analytics-view-value")||"",n=p(t,"data-analytics-view-label")||"";let i=ne({contextNode:t});if(t.firstChild&&t.firstChild.nodeType===Node.ELEMENT_NODE&&(i=Object.assign({},i,{},se(t.firstChild,"data-analytics-view-custom-"))),u(t,"data-item"))return this.markParentBoxAsVisible(t),void this.sendItemViewEvent({contextNode:t,label:n,value:s,customParams:i});i=Object.assign({},i,{},(e=>{if(!e)return{};const t=p(e,"data-analytics-box-view-custom-params");if(!t)return{};let s={};try{s=r(decodeURIComponent(t))}catch(n){console.log(n)}return s})(t)),this.sendBoxViewEvent({contextNode:t,value:s,customParams:i})}sendPageViewProxy(){this.sendPerformanceMetrics(),this.cookieMonsterClient.sendPageView(this.defaultCustomParams.pv),this.cookieMonsterClient.updateReferrer()}sendEventProxy(e,t,r,s,n){return e.nodeType===Node.ELEMENT_NODE?this.sendEvent({value:r,label:n,action:t,contextNode:e,customParams:s}):this.sendEvent(e)}sendItemViewEventProxy({contextNode:e,label:t,value:r,customParams:s}){this.sendItemViewEvent({contextNode:e,label:t,value:r,customParams:ne({contextNode:e,customParams:s})})}sendClickEventProxy({contextNode:e,label:t,value:r,customParams:s,destinationUrl:n,isNewTab:i}){if(i&&"boolean"!=typeof i)throw Error("isNewTab property must be boolean");this.sendClickEvent({contextNode:e,label:t,value:r,customParams:ie({contextNode:e,destinationUrl:n,customParams:s,isNewTab:i})})}sendContextmenuEventProxy({contextNode:e,label:t,value:r,customParams:s,destinationUrl:n}){this.sendContextmenuEvent({contextNode:e,label:t,value:r,customParams:ie({contextNode:e,destinationUrl:n,customParams:s})})}sendBoxInteractionEventProxy({contextNode:e,label:t,value:r,customParams:s}){this.sendBoxInteractionEvent({contextNode:e,label:t,value:r,customParams:oe({contextNode:e,customParams:s})})}updateCustomParams({pv:e={},ev:t={}}={}){n(e)&&n(t)?this.defaultCustomParams={pv:e,ev:t}:console.log("Can not update custom params with non-object arguments!")}registerEventCallback(e){e&&!this.eventCallbacks.includes(e)&&this.eventCallbacks.push(e)}createAPI(){return{sendPageView:this.sendPageViewProxy.bind(this),sendEvent:this.sendEventProxy.bind(this),sendItemViewEvent:this.sendItemViewEventProxy.bind(this),sendClickEvent:this.sendClickEventProxy.bind(this),sendContextmenuEvent:this.sendContextmenuEventProxy.bind(this),sendBoxInteractionEvent:this.sendBoxInteractionEventProxy.bind(this),registerEventCallback:this.registerEventCallback.bind(this)}}}function le(e){return n(e)&&!("clientImplementationVersion"in e)?Object.assign(e,{clientImplementationVersion:""}):e}function de({instance:e,method:t,reportError:r,data:s=null,onSuccess:n=(()=>{})}){if(e&&a(e[t]))try{e[t](s),n()}catch(i){r(i)}}function he(e,t){return""===t?e:`${e}@${t}`}class ue{constructor({targetWindow:e,services:t,reportError:r,unmountNodeCallback:s,mountNodeCallback:n,componentNodesFinder:i,serializedPropsFinder:o,registerPrototypeCallback:a}={}){this.targetWindow=e,this.services=t,this.implementations=new Map,this.instances=new Map,this.boxDataCache=new Map,this.reportError=r,this.unmountNodeCallback=s,this.mountNodeCallback=n,this.registerPrototypeCallback=a,this.serializedPropsFinder=o,this.componentNodesFinder=i}unmountNode(e){this.unmountNodeCallback(e),d(e,"div[data-prototype-id]").concat([e]).forEach(e=>{const t=g(e)||b(e);de({instance:this.instances.get(t),method:"onUnmount",reportError:this.reportError}),this.instances.set(t,null)})}mountNode(e){d(e,"div[data-prototype-id]").concat([e]).forEach(e=>{const t=m(e),r=f(e)||"";this.registerInstancesForPrototype(t,r,[e])}),this.mountNodeCallback(e)}isPrototypeObjectValid(e){const{prototypeName:t,clientImplementationVersion:r}=e;return"prototypeName"in e?""===t?(this.reportError(Error('Property "prototypeName" cannot be empty string')),!1):i(t)?!!i(r)||(this.reportError(Error('Property "clientImplementationVersion" must be string but got '+typeof r)),!1):(this.reportError(Error('Property "prototypeName" must be string but got '+typeof t)),!1):(this.reportError(Error('Property "handledPrototype" must have "prototypeName" field')),!1)}containsValidPrototypes(e){return 0===e.length?(this.reportError(Error("Empty handledPrototypes list")),!1):!e.filter(e=>!this.isPrototypeObjectValid(e)).length}isPrototypeValid(e){return s(e)?this.containsValidPrototypes(e):n(e)?this.isPrototypeObjectValid(e):(this.reportError(Error('"handledPrototype" argument must be an object or an array')),!1)}isImplementationValid(e){return a(e)?e.prototype.onUpdate&&!a(e.prototype.onUpdate)?(this.reportError(Error('"onUpdate" property must be a function or undefined but got '+typeof e.prototype.onUpdate)),!1):!!a(e.prototype.onMount)||(this.reportError(Error('"implementation" class has to have "onMount" method')),!1):(this.reportError(Error('"implementation" must be a class')),!1)}registerInstancesForPrototype(e,t,r){const s=this.implementations.get(he(e,t));s&&(this.registerInstances(r,this.services.getServicesForComponent(e),s),this.registerPrototypeCallback(e,t))}registerImplementationAndInstances({prototypeName:e,clientImplementationVersion:t},r){const s=he(e,t),n=""===t;this.implementations.has(s)?this.reportError(Error(`${e} ${n?"":`with ${t} client implementation version `}already registered!`)):(this.implementations.set(s,r),this.registerInstancesForPrototype(e,t,this.componentNodesFinder.find(e,t)))}updateComponentCallback(e,t){const r=this.instances.get(e);r?de({instance:r,method:"onUpdate",reportError:this.reportError,data:t}):this.boxDataCache.set(e,t)}beforeUpdateComponentCallback(){this.instances.forEach(e=>de({instance:e,method:"beforeOnUpdate",reportError:this.reportError}))}registerInstances(e,t,r){e.forEach(e=>{if(p(e,"data-pathname"))return;const s=b(e),n=g(e),i=this.serializedPropsFinder.getPropsForBox(n,s),o=new r({baseNode:e,props:i,services:t}),a=n||s;this.instances.get(a)||(de({instance:o,method:"onMount",reportError:this.reportError,onSuccess:()=>{this.instances.set(a,o)}}),this.boxDataCache.has(a)&&(de({instance:o,method:"beforeOnUpdate",reportError:this.reportError}),this.updateComponentCallback(a,this.boxDataCache.get(a)),this.boxDataCache.delete(a)))})}register(e,t){const r=(e=>s(e)?e.map(le):le(e))(e);this.isPrototypeValid(r)&&this.isImplementationValid(t)&&(s(r)?r.forEach(e=>{this.registerImplementationAndInstances(e,t)}):this.registerImplementationAndInstances(r,t))}createPublicAPI(){return{register:this.register.bind(this)}}createPrivateAPI(){return{updateComponentCallback:this.updateComponentCallback.bind(this),beforeUpdateComponentCallback:this.beforeUpdateComponentCallback.bind(this),unmountNode:this.unmountNode.bind(this),mountNode:this.mountNode.bind(this),updateSerializedPropsCollection:()=>{this.serializedPropsFinder.updateNodesCollection()},updateComponentNodesCollection:()=>{this.componentNodesFinder.updateNodesCollection()}}}}class pe{constructor(e,t){this.targetWindow=e,this.reportError=t,this.collection=[],this.updateNodesCollection()}updateNodesCollection(){this.collection=d(this.targetWindow.document,"script[data-serialize-box-id], script[data-serialize-box-name]")}getNodeByBoxId(e){return this.collection.find(t=>p(t,"data-serialize-box-id")===e)}getNodeByBoxName(e){return this.collection.find(t=>p(t,"data-serialize-box-name")===e)}getPropsFromNode(e){if(!e)return{};try{return r(M(e))}catch(t){return this.reportError(t),{}}}getPropsForBox(e,t){const r=this.getNodeByBoxId(e)||this.getNodeByBoxName(t);return r?this.getPropsFromNode(r):{}}}const me=(e,t)=>({prototypeName:e},r)=>{e&&r({domNodes:t.find(e)})};function ge(e,t){if(null==e)return{};var r,s,n={},i=Object.keys(e);for(s=0;s<i.length;s++)r=i[s],t.indexOf(r)>=0||(n[r]=e[r]);return n}const be=()=>Promise.reject(Error("missing edge host"));class fe{constructor({httpClient:e,edgeHost:t,language:r}){this.edgeHost=t,this.httpClient=e,this.defaultHeaders={"Content-Type":"application/vnd.allegro.public.v1+json",Accept:"application/vnd.allegro.public.v1+json","Accept-Language":r}}prepareRequestSettings(e={},t=!1){if(e.disableDefaultHeaders)return e;const r=this.normalizeSettings(e),s=ge(this.defaultHeaders,["Content-Type"]);return J({},t?{headers:s}:{headers:this.defaultHeaders},r)}normalizeSettings(t){if(!t||!t.headers)return t;const r=function e(t,r){return Object.keys(t).reduce((s,n)=>{const i=t[n],o="object"==typeof i?e(i,r):i;return s[r.find(e=>n.toLowerCase()===e.toLowerCase())||n]=o,s},{})}(t.headers,Object.keys(this.defaultHeaders));return e(t,{headers:r})}prepareRequestUrl(e){return this.edgeHost+e}get(e,t){return this.httpClient.get(this.prepareRequestUrl(e),this.prepareRequestSettings(t,!0))}put(e,t,r){return this.httpClient.put(this.prepareRequestUrl(e),t,this.prepareRequestSettings(r))}post(e,t,r){return this.httpClient.post(this.prepareRequestUrl(e),t,this.prepareRequestSettings(r))}patch(e,t,r){return this.httpClient.patch(this.prepareRequestUrl(e),t,this.prepareRequestSettings(r))}delete(e,t){return this.httpClient.delete(this.prepareRequestUrl(e),this.prepareRequestSettings(t,!0))}createAPI(){return this.edgeHost?{get:this.get.bind(this),put:this.put.bind(this),post:this.post.bind(this),patch:this.patch.bind(this),delete:this.delete.bind(this)}:{get:be,put:be,post:be,patch:be,delete:be}}}class ve{constructor({targetWindow:e,alias:t="cm",config:r={},isExternal:s=!1}){const{cookieMonster:{host:n,account:i,defaultCustomParams:o={},referrer:a=document.referrer}}=r;this.targetWindow=e,this.document=this.targetWindow.document,this.alias=t,this.host=n,this.account=i,this.isExternal=s,this.defaultCustomParams=o,this.referrer=a}initialize(){if(this.isExternal)return this.loadExternal(),void this.callCookieMonster.call(this,"create",this.account);this.host&&this.account&&!this.isLoaded()?(this.load(),this.callCookieMonster.call(this,"create",this.account),this.sendPageView(),this.updateReferrer()):this.updateReferrer()}load(){this.isLoaded()||((e,t,r,s,n)=>{e["cm.analytics.object"]=n,e[n]=e[n]||((...t)=>{(e[n].q=e[n].q||[]).push(t)});const i=v(t,"script",{src:s}),o=t.getElementsByTagName("script")[0];o.parentNode.insertBefore(i,o)})(this.targetWindow,this.document,0,this.host,this.alias)}loadExternal(){this.isLoaded()||((e,t)=>{e["cm.analytics.object"]=t,e[t]=e[t]||((...r)=>{(e[t].q=e[t].q||[]).push(r)})})(this.targetWindow,this.alias)}send(...e){this.callCookieMonster.call(this,this.sendCommand(),...e)}sendPageView(e=this.defaultCustomParams.pv||{}){this.send("pageview",{customParams:e,referrer:this.referrer})}updateReferrer(){this.referrer=window.location.href}callCookieMonster(...e){this.isLoaded()&&this.targetWindow[this.alias].apply(null,e)}isLoaded(){return"function"==typeof this.targetWindow[this.alias]}sendCommand(){return"send@"+this.account}}class ye{constructor({targetWindow:e,boxes:t=[],significantElementSizePercentage:r=.75,timeoutValue:s=500,debounceTimeoutValue:n=20}){this.targetWindow=e,this.config={timeoutValue:s,debounceTimeoutValue:n,significantElementSizePercentage:r},this.resetState(),this.boxes=t.length?t:G(e.document),this.visibleElements=[],this.visibleElementsByIntersectionObserver=new Set,this.notVisibleElements=new Set,this.observer=new this.targetWindow.IntersectionObserver(this.intersectionHandler.bind(this),{threshold:r}),this.scrollHandlerWithContext=this.scrollHandler.bind(this),this.scrollEndHandler=w(this.resetCurrentlyVisibleElementsAfterScroll,this.config.debounceTimeoutValue),this.resetCurrentlyVisibleElementsOnTimeout=function(e,t,r){let s;return function(...r){const n=this;return new Promise(i=>{clearTimeout(s),s=setTimeout(()=>{s=null,i(e.apply(n,r))},t)})}}(this.resetCurrentlyVisibleElements.bind(this),this.config.debounceTimeoutValue),this.markCurrentlyVisibleElementsAsSeenOnTimeout=w(this.markCurrentlyVisibleElementsAsSeen.bind(this),this.config.timeoutValue)}resetState(){const e=(new Date).getTime();this.state={isScrolling:!1,scrollStartTime:e,counterStartTime:e}}markPreviouslyVisibleElementsAsSeen(){const e=(new Date).getTime();this.visibleElements.forEach(t=>{Z(t,e-this.state.counterStartTime,this.config.timeoutValue)})}markPreviouslyVisibleElementsAsSeenAfterScroll(){this.visibleElements.forEach(e=>{Z(e,this.state.scrollStartTime-this.state.counterStartTime,this.config.timeoutValue)})}markCurrentlyVisibleElementsAsSeen(){const{timeoutValue:e}=this.config;this.visibleElements.forEach(t=>{Z(t,e,e)})}intersectionHandler(e){e.forEach(({target:e,boundingClientRect:t,rootBounds:r})=>{r&&((e,t,r)=>{const s=e.right-e.left,n=e.bottom-e.top,i=ee(e.left,e.right,t.width,s);return ee(e.top,e.bottom,t.height,n)*i/(s*n)>r})(t,r,this.config.significantElementSizePercentage)?(this.visibleElementsByIntersectionObserver.add(e),this.notVisibleElements.delete(e),P(e,"inViewport",this.targetWindow.document)):this.visibleElementsByIntersectionObserver.has(e)?(this.visibleElementsByIntersectionObserver.delete(e),P(e,"outOfViewport",this.targetWindow.document)):this.notVisibleElements.add(e)}),this.resetCurrentlyVisibleElementsOnTimeout()}resetCurrentlyVisibleElements(){this.markPreviouslyVisibleElementsAsSeen(),this.visibleElements=[],this.visibleElementsByIntersectionObserver.forEach(e=>this.visibleElements.push(e)),this.markCurrentlyVisibleElementsAsSeenOnTimeout(),this.resetState()}resetCurrentlyVisibleElementsAfterScroll(){this.markPreviouslyVisibleElementsAsSeenAfterScroll(),this.notVisibleElements.forEach(e=>{this.observer.unobserve(e),this.observer.observe(e)}),this.markCurrentlyVisibleElementsAsSeenOnTimeout(),this.resetState()}scrollHandler(){this.state.isScrolling||(this.state.scrollStartTime=(new Date).getTime(),this.state.isScrolling=!0),clearTimeout(this.markCurrentlyVisibleElementsAsSeenOnTimeout()),this.scrollEndHandler()}addBox(e){null!==e&&-1===this.boxes.indexOf(e)&&(this.boxes.push(e),this.observer.observe(e))}isBoxInViewport(e){return this.visibleElementsByIntersectionObserver.has(e)}markBoxAsRendered(e){return u(e,"data-analytics-enabled")&&this.addBox(e),G(e).forEach(e=>this.addBox(e)),Promise.resolve()}markBoxAsVisible(e,t=!1){if(this.addBox(e),t){const{timeoutValue:t}=this.config;Z(e,t,t)}}recursivelyMarkBoxAsVisible(e,t=!1){this.markBoxAsVisible(e,t),G(e).forEach(e=>this.markBoxAsVisible(e,t))}removeBox(e){var t;null!==e&&(t=e,K.delete(t),Q.delete(t),this.boxes=this.boxes.filter(t=>t!==e),this.visibleElements=this.visibleElements.filter(t=>t!==e),this.observer.unobserve(e))}markBoxAsHidden(e){this.removeBox(e),this.resetCurrentlyVisibleElementsOnTimeout()}unmountNode(e){X(e).forEach(e=>this.removeBox(e))}recursivelyMarkBoxAsHidden(e){this.markBoxAsHidden(e),G(e).forEach(e=>this.markBoxAsHidden(e))}trackBoxScroll(e){R(e,"scroll",this.scrollHandlerWithContext)}initialize(){R(this.targetWindow,"scroll",this.scrollHandlerWithContext),this.boxes.forEach(e=>this.observer.observe(e))}createAPI(){return{markBoxAsRendered:this.markBoxAsRendered.bind(this),markBoxAsVisible:this.markBoxAsVisible.bind(this),recursivelyMarkBoxAsVisible:this.recursivelyMarkBoxAsVisible.bind(this),markBoxAsHidden:this.markBoxAsHidden.bind(this),recursivelyMarkBoxAsHidden:this.recursivelyMarkBoxAsHidden.bind(this),trackBoxScroll:this.trackBoxScroll.bind(this),isBoxInViewport:this.isBoxInViewport.bind(this)}}}var Ce=e=>t=>{0===t.status||(e.newrelic?(console.error("Reporting error to newrelic: "+t.message),e.newrelic.noticeError(t)):console.error("Error: "+t.message),e.opbox.plugin.get("sentry").then(e=>e.captureException(t)).catch(E))};const Ee=(e,t)=>{function r(e){const t=/([^&=]+)=?([^&]*)/g,r={},s=e.substring(e.indexOf("?")+1,e.length);let n;for(;n=t.exec(s);)i=r,o=decodeURIComponent(n[1]),a=decodeURIComponent("string"===n[1]?n[2].replace(/\+/g," "):n[2]),void 0===i[o]?i[o]=[a]:i[o].push(a);var i,o,a;return r}const s=r(e);let n;const i=((e,t)=>{for(let r=0,{length:s}=e;r<s;r+=1)if("route"===e[r].name)return e[r];return null})(s);function o(e){t.forEach(t=>{return r=e,s=t.name,n=t.value,void(r[s]=Array.isArray(n)?n:[n]);var r,s,n})}function a(e){return Object.keys(e).map(t=>e[t].map(e=>[t,e])).reduce(x,[]).reduce((e,[t,r])=>null!=r?`${e}${(e?"&":"?")+encodeURIComponent(t)}=${encodeURIComponent(r)}`:e,"")}return i&&0===i.value.indexOf("http")?(n=2===i.value.split("?").length?r(i.value.split("?")[1]):[],o(n),i.value=i.value.split("?")[0]+a(n)):o(s),a(s)};class we{constructor({targetWindow:e,opboxWebClient:t,rawDataListenersRegistry:r,reportError:s}){const{location:n}=e;this.targetWindow=e,this.opboxWebClient=t,this.rawDataListenersRegistry=r,this.reportError=s,this.history=[n.pathname],this.lastFetchPath=n.pathname+n.search,this.changeCallbacks=[],this.changeStateCallbacks=[]}initialize(){this.targetWindow.onpopstate=e=>this.handlePopState(e),this.targetWindow.history.replaceState({opboxjs:!0},"")}isInternalNavigation(e){return this.history.find(t=>t===e)}navigateRelative(e,{persistHash:t=!1}={}){const{pathname:r,search:s,hash:n}=this.targetWindow.location,i=t?n:"",o=r+s+i,a=e.filter(e=>!e.fetchUrlOnly),c=r+Ee(s,a)+i,l=r+Ee(s,e)+i;return l!==this.lastFetchPath&&this.fetch(l),c!==o&&(this.changeUrl(c),this.history.push(r),this.changeCallbacks.forEach(e=>e()),this.targetWindow.performance.mark("clientSideNavigationStart")),c}refreshPage(){const{pathname:e,search:t}=this.targetWindow.location,r=e+t;this.fetch(r)}changeUrl(e){this.targetWindow.history.pushState("","",e)}changeState({queryParameters:e,hash:t,shouldChangeHistory:r}){if(!e&&!i(t))return this.reportError(Error("New parameters (array) or hash (string) required")),null;const{pathname:s,search:n,hash:o}=this.targetWindow.location,a=s+n+o,c=i(t)?""===(l=t)||"#"===l.charAt[0]?l:"#"+l:o;var l;const d=s+Ee(n,e||[])+c;if(d!==a){const e=r?"pushState":"replaceState";this.targetWindow.history[e]("","",d),this.changeStateCallbacks.forEach(e=>e())}return d}handlePopState(e){const{pathname:t,search:r}=e.target.location,s=t+r;this.isInternalNavigation(t)&&this.lastFetchPath!==s&&this.refreshPage()}fetch(e){this.lastFetchPath=e,this.rawDataListenersRegistry.triggerProgressListener(),this.opboxWebClient.getPageData(e).then(e=>this.rawDataListenersRegistry.triggerChangeListener(e)).catch(Ce)}registerChangeCallback(e){this.registerCallback(e,this.changeCallbacks)}registerChangeStateCallback(e){this.registerCallback(e,this.changeStateCallbacks)}registerCallback(e,t=[]){a(e)?t.push(e):this.reportError(Error(`First argument must be a function but got "${typeof e}"`))}createAPI(){return{registerChangeCallback:this.registerChangeCallback.bind(this),registerChangeStateCallback:this.registerChangeStateCallback.bind(this),changeState:this.changeState.bind(this)}}}const Pe="opboxAnimationTimerInterval";function xe(e,t,r,s,{duration:n=500,onFinish:i}={}){if("function"!=typeof s)return null;const o=(e=>e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||(e=>{setTimeout(e,1e3/60)}))(e),a=Date.now(),c=r-t;let l=!1;const d=()=>{const e=Date.now()-a;if(l||e>=n)"function"==typeof i&&i(),l=!1;else{const i=((r=Math.min(e/n,1))<.5?8*r*r*r*r:1-8*--r*r*r*r)*c+t;s(i),o(d)}var r};return d(),{stop(){l=!0}}}function ke(e,t=0,{duration:r=500}={}){const s=e.pageYOffset,n=Math.max(0,t),i=e.document.body.scrollHeight;function o(){e[Pe]&&"function"==typeof e[Pe].stop&&(e[Pe].stop(),e[Pe]=null)}o(),e[Pe]=xe(e,s,t,t=>{e.scrollTo(0,Math.round(t)),(t=>{const r=t===n||t===n,s=e.innerHeight+t>=i;return r||s})(t)&&o()},{duration:r})}class Se{constructor(){this.status=1,this.promise=new Promise(e=>{this.resolve=e})}registerImplementation(e){this.status=2,this.resolve(e)}}class Ne{constructor({reportError:e,allowedPlugins:t=[]}={}){this.reportError=e,this.pluginsRegistry=new Map,this.boundUpdateRegistry=this.updateRegistry.bind(this),this.updateRegistry(t)}isPluginAvailable(e){return this.pluginsRegistry.has(e)}reportRegistrationError(e,t=!1){const r=Error("Plugin registration error. "+e);t?console.error(r):this.reportError(r)}addPluginToRegistry({name:e}){this.isPluginAvailable(e)||this.pluginsRegistry.set(e,new Se)}register(e,t){if(!e)return void this.reportRegistrationError('First argument "config" should be defined');const{name:r}=e;if("string"!=typeof r)return void this.reportRegistrationError('Property "name" should be a string');if(!r)return void this.reportRegistrationError('Property "name" should be a non-empty string');if(!t)return void this.reportRegistrationError('Second argument "implementation" is required');if(!this.isPluginAvailable(r))return void this.reportRegistrationError(`Plugin "${r}" is not allowed to register on this page`);const s=this.pluginsRegistry.get(r);2!==s.status?s.registerImplementation(t):this.reportRegistrationError(`Plugin "${r}" is already registered on page`,!0)}getPlugin(e){return this.isPluginAvailable(e)?this.pluginsRegistry.get(e).promise:Promise.reject(Error(`Plugin "${e}" is unavailable`))}updateRegistry(e=[]){e.forEach(this.addPluginToRegistry.bind(this))}createAPI(){return{register:this.register.bind(this),get:this.getPlugin.bind(this)}}}function Ie(e,t){return r=>{if(!e.has(r))return Promise.reject(Error(`Service ${r} is not registered`));const s=e.get(r);return s.fetchIfNotFetched(t),s.promise}}class Re{constructor({prototypeName:e,servicesRegistry:t,targetWindow:r}){this.services=new Map,this.targetWindow=r,t.forEach((t,r)=>{t.components.some(t=>t.prototypeName===e)&&this.services.set(r,t)}),this.get=Ie(this.services,this.targetWindow)}has(e){return this.services.has(e)}}function Ae(e,t){return t.filter(t=>{return!e.find((r=t,e=>{if(r.url)return[e.url,e.href,e.src].includes(r.url);if(r.code){const{attributes:t={}}=r,s=!Object.keys(t).some(r=>t[r]!==p(e.node,r));return r.code===e.code&&s}return!1}));var r})}function Me(e,t,r){if(!t.length)return Promise.resolve();const s=(e=>l(e.document.getElementsByTagName("script"),e=>({src:e.src,code:e.innerHTML,nonce:e.nonce,node:e})))(e),n=(e=>(e.find(({nonce:e})=>!!e)||{}).nonce)(s),i=Ae(s,t);return Promise.all(i.map(((e,t,r=E)=>{const s=Ce(e),n=(e=>"noModule"in e.document.createElement("script"))(e);return({url:i,code:o,attributes:a,type:c,async:l})=>i||o?new Promise(d=>{const h=!i&&!!o,u="module"===c,p=v(e.document,"script");let m,g=!1;const b=e=>{d(),e.message||(e.message="Error while loading script: "+i),s(e),p.removeEventListener("error",b)},f=()=>{d(),p.removeEventListener("error",b),p.removeEventListener("load",f)};if(!u||n){if(a){if(a.nomodule&&n)return void d();Object.entries(a).forEach(([t,r])=>{"data-serialize-box-id"!==t&&"data-serialize-box-name"!==t||(g=!0,m=e.document.querySelector(`[${t}="${r}"]`)),p.setAttribute(t,r)})}t&&p.setAttribute("nonce",t),l&&p.setAttribute("async","async"),c&&(p.type=c),h?(p.innerHTML=o,d()):(p.src=i,p.addEventListener("load",f),p.addEventListener("error",b)),m?m.parentNode.replaceChild(p,m):e.document.body.appendChild(p),g&&r()}else d()}):Promise.resolve()})(e,n,r)))}class Oe{constructor({assetUrl:e,components:t,reportError:r}){this.assetUrl=e,this.components=t,this.reportError=r,this.implementation=null,this.status=0,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}update(e){this.components=((e,t)=>t.reduce((e,t)=>e.find(({prototypeName:e})=>e===t.prototypeName)?e:e.concat(t),e))(this.components,e)}registerImplementation(e){try{this.implementation=new e,this.status=2,this.resolve(this.implementation)}catch(t){this.handleError(t)}}fetchIfNotFetched(e){0===this.status&&(this.status=1,Me(e,[{url:this.assetUrl}]).catch(e=>{this.handleError(e)}))}handleError(e){this.reportError(e),this.status=2,this.reject()}}class We{constructor({targetWindow:e,reportError:t}){this.targetWindow=e,this.reportError=t,this.servicesRegistry=new Map;const s=this.targetWindow.document.querySelector('script[data-config="services"]');if(s)try{r(M(s)).forEach(([e,{assetUrl:t,components:r}])=>{this.setServiceToRegistry(e,t,r)})}catch(n){this.reportError(n)}this.dangerouslyGet=Ie(this.servicesRegistry,this.targetWindow),this.update=this.update.bind(this)}getServicesForComponent(e){return new Re({prototypeName:e,servicesRegistry:this.servicesRegistry,targetWindow:this.targetWindow})}setServiceToRegistry(e,t,r){this.servicesRegistry.set(e,new Oe({assetUrl:t,components:r,reportError:this.reportError}))}update(e){e.forEach(([e,{assetUrl:t,components:r}])=>{this.servicesRegistry.has(e)?this.servicesRegistry.get(e).update(r):this.setServiceToRegistry(e,t,r)})}register({serviceName:e},t){this.servicesRegistry.get(e).registerImplementation(t)}createAPI(){return{register:this.register.bind(this),__dangerouslyGet__:this.dangerouslyGet.bind(this)}}}const Te=()=>Date.now();class Ve{constructor({localStorage:e,reportError:t,ttlMs:r=2592e6,key:s="opbox.preferences",timeProvider:n=Te}){this.writeToStorage=this.writeToStorage.bind(this),this.loadPreferences=this.loadPreferences.bind(this),this.cleanupPreferences=this.cleanupPreferences.bind(this),this.savePreferences=this.savePreferences.bind(this),this.storage=(e=>{try{const t="test_preferences_storage";return e.setItem(t,t),e.getItem(t),e.removeItem(t),!0}catch(t){return!1}})(e)?e:{setItem(){},getItem(){return{}}},this.ttlMs=r,this.key=s,this.timeProvider=n,this.reportError=t}savePreferences(e){const t=this.loadPreferences(),r=this.timeProvider(),s=e.reduce(I(({name:e,value:t})=>({[e]:{value:t,timestamp:r}})),t);this.writeToStorage(s)}writeToStorage(e){try{this.storage.setItem(this.key,JSON.stringify(e))}catch(t){this.reportError(t)}}loadPreferences(){try{return r(this.storage.getItem(this.key))||{}}catch(e){return this.reportError(e),{}}}cleanupPreferences(){const e=this.loadPreferences(),t=this.timeProvider(),r=Object.entries(e).reduce(I(([e,r])=>r.timestamp+this.ttlMs>t?{[e]:r}:{}),{});this.writeToStorage(r)}}const je={withCredentials:!0,headers:{"Content-Type":"application/vnd.allegro.internal.v1+json",Accept:"application/vnd.allegro.internal.v1+json"}};class Be{constructor({edgeClient:e,localStorage:t,ttlMs:r,reportError:s}){this.edgeClient=e,this.storage=new Ve({localStorage:t,ttlMs:r,reportError:s}),this.setPreference=this.setPreference.bind(this),this.getPreference=this.getPreference.bind(this),this.setPreferences=this.setPreferences.bind(this),this.getPreferences=this.getPreferences.bind(this),this.getPreferencesFromLocalStorageOrDefaults=this.getPreferencesFromLocalStorageOrDefaults.bind(this)}setPreference(e,t){const r={name:e,value:t};return this.storage.savePreferences([r]),this.edgeClient.post("/preferences",r,je)}getPreference(e,t){return"string"==typeof e||e instanceof String?this.getPreferences({[e]:t}).then(t=>t[e]):Promise.reject(Error("illegal argument type provided as preference name"))}setPreferences(e){if(!n(e))return Promise.reject(Error("illegal argument type provided as preferences"));const t=Object.entries(e).map(([e,t])=>({name:e,value:t}));return this.storage.savePreferences(t),this.edgeClient.post("/preferences/multi",JSON.stringify(t),je)}getPreferences(e){if(!n(e))return Promise.reject(Error("illegal argument type provided as preferences"));const t="/preferences?name="+Object.keys(e).join(","),{withCredentials:r}=je,s=ge(je.headers,["Content-Type"]);return this.edgeClient.get(t,{withCredentials:r,headers:s}).then(({data:{preferences:e}})=>(this.storage.savePreferences(e),e.reduce(I(({name:e,value:t})=>({[e]:t})),{}))).catch(()=>this.getPreferencesFromLocalStorageOrDefaults(e))}getPreferencesFromLocalStorageOrDefaults(e){this.storage.cleanupPreferences();const t=this.storage.loadPreferences();return Object.entries(e).reduce(I(([e,r])=>({[e]:e in t?t[e].value:r})),{})}createAPI(){return{set:this.setPreference,get:this.getPreference,setMany:this.setPreferences,getMany:this.getPreferences}}}function Le(e,t,{inHead:r=!1,referenceNode:s=null}={}){return n=>{if(c(n))return null;k(n,(e,t)=>!t);const i=v(e.document,"link",n,{rel:t});if(s)((e,t)=>{e.insertAdjacentElement("beforebegin",t)})(s,i);else{const t=r?"head":"body";e.document[t].appendChild(i)}return i}}var Ue=["spinner","button","link","badge","brand","bubble","card","chart","desk","divider","heading","hint","icon","indicator","input","list","timeline","marker","notification","placeholder","price","progress","table","dropdown","breadcrumb","accordion","carousel","chip","choice","dialog","field","image-tile","input-group","message","modal","pagination","range","select","sheet","slider","soap","stepper","tabs","typography","color","grid","calendar","attachment","article","navigation-tiles","pin","player-video","align","border","box-sizing","display","flex","height","margin","padding","position","transition","utils","visibility","white-space","width","zindex","core"];function ze(e){return d(e,'link[type="text/css"],style',e=>({href:e.href,code:e.innerHTML,media:e.media,node:e,isMetrum:y(e.href)})).filter(({href:e,code:t})=>e||t)}function He(e,t,s){const n=[],i=h(e,s.selectors.bundledStylesMap);if(!i)return n;try{return r(M(i))}catch(o){return t(Error("Bundled styles map: invalid JSON")),n}}var De=(e,{href:t,media:r},s)=>{const n=Le(e,"stylesheet",{inHead:!0,referenceNode:s})({type:"text/css",href:t,media:r});return new Promise((e,t)=>{n.addEventListener("error",t),n.addEventListener("load",e)})};const Fe=e=>({href:t})=>-1!==t.indexOf(e);function qe(e,t){return l(e.cssRules).findIndex(e=>e.selectorText===t)}let $e;function _e({targetWindow:e,webResponse:t,config:r}){const{svgColorMatrixFilters:s="",assets:{styles:n=[],prefetches:i=[],preloads:o=[]}}=t;return(({document:e},t)=>{if(!t)return;const r=h(e,"#svg-color-matrix-filters"),s=v(e,"div",{innerHTML:t}).querySelector("svg");r?d(s,"filter",e=>{r.querySelector("#"+p(e,"id"))||r.appendChild(e)}):e.body.insertBefore(s,e.body.firstChild)})(e,s),o.forEach(Le(e,"preload")),i.forEach(Le(e,"prefetch")),((e,t,r)=>{if(!t.length)return Promise.resolve();const s=[...ze(e.document),...He(e.document,Ce(e),r)],n=Ae(s,t);$e=$e&&!$e.forceRefresh?$e:((e,{cssBundle:{isBundleEnabled:t,emptyRule:r}},s)=>{const n=t?(e=>l(e.document.styleSheets).find(({ownerNode:e})=>e&&u(e,"data-metrum-bundle")))(e):null;let i=[];const o=e=>r.pattern.replace(r.replacementPart,e);return{isBundleEnabled:t,inject(r){if(!t)return Promise.resolve();const[a,c]=((e,t)=>t.reduce(([t,r],s)=>(e.includes(s)||r.push(s),t.push(s),[t,r]),[[],[]]))(i,r);return i=a,c.length?((e,t)=>{const r=v(e,"iframe",{style:"display:none"}),s=()=>e.body.removeChild(r);e.body.appendChild(r);const{contentDocument:n,contentWindow:i}=r;return n.open("text/html","replace"),n.write(t.map(A).join("")),n.close(),new Promise(e=>{const r=()=>e([l(n.styleSheets),s]),o=()=>{i.removeEventListener("load",o),r()};"complete"===n.readyState&&n.styleSheets.length===t.length?r():i.addEventListener("load",o)})})(e.document,c).then(([e,t])=>{e.forEach(e=>{if(((e,t)=>t.cssRules.length>0&&l(e.cssRules).findIndex(e=>e.cssText===t.cssRules[0].cssText)>-1)(n,e))return;const t=C(e.href),r=s.indexOf(t),i=-1!==r?s.slice(r):[];i.push("non-metrum");let a=n.cssRules.length;for(let s=0;s<i.length;s+=1){const e=qe(n,o(i[s]));if(e>0){a=e;break}}const c=l(e.cssRules);c.unshift({cssText:o(t)+"{}"});for(let s=0;s<c.length;s+=1)n.insertRule(c[s].cssText,a+s)}),t()}):Promise.resolve()}}})(e,r,Ue);const{inject:i,isBundleEnabled:o}=$e,[a,c]=n.reduce((t,r)=>y(r.url)&&o?(t[0].push(r.url),t):(t[1].push(((e,t,{url:r,code:s,media:n})=>y(r)?((e,t,{href:r,media:s},n)=>{const i=C(r);return n.includes(i)?De(e,{href:r,media:s},((e,t,r)=>{const s=e.filter(({isMetrum:e})=>e),n=t.slice(0,t.indexOf(r)).reverse().find(e=>s.find(Fe(e))),i=n?s.find(Fe(n)).node:null;return!i&&s.length?s[0].node.previousElementSibling:!i&&e.length?e[0].node.previousElementSibling:i})(t,n,i)):Promise.resolve()})(e,t,{href:r,media:n},Ue):r?De(e,{href:r,media:n}):s?((e,t)=>{const r=v(e.document,"style",{innerHTML:t});return e.document.head.appendChild(r),Promise.resolve()})(e,s):Promise.reject())(e,s,r)),t),[[],[]]);return c.push(i(a)),Promise.all(c)})(e,n,r)}function Je({targetWindow:e,webResponse:t,lazyScriptsManager:r,updateSerializedPropsCollectionCallback:s}){const{assets:{scripts:n=[]}}=t,[i,o]=n.reduce((e,t)=>(t.lazyDownload?e[0].push(t):e[1].push(t),e),[[],[]]);return Me(e,o,s).then(()=>r.handleSubtreeAssets(i))}var Xe=({config:e,targetWindow:t,unmountNodeCallback:r,mountNodeCallback:s,updateServicesCallback:n,updateAllowedPluginsCallback:i,updateSerializedPropsCollectionCallback:o,updateComponentNodesCollectionCallback:a,injectStylesPreloadsAndPrefetches:c=_e,injectScripts:l=Je,lazyScriptsManager:d})=>{function h(e){return t.document.querySelector(`[data-box-id="${e}"]`)}return({boxId:u,data:p,isPlaceholder:m})=>{const{htmlString:g,servicesConfig:b,allowedPlugins:f}=p;return n(b),i(f),c({targetWindow:t,webResponse:p,config:e}).then(()=>{const e=m?(e=>t.document.querySelector(`[data-placeholder-for="${e}"]`))(u):h(u);if(r(e),!g)return e.parentNode.removeChild(e),!1;const s=v(t.document,"div",{innerHTML:g});return e.parentNode.replaceChild(s.firstElementChild,e),!0}).then(e=>{a(),l({targetWindow:t,webResponse:p,lazyScriptsManager:d,updateSerializedPropsCollectionCallback:o}).then(()=>e&&s(h(u)))})}},Ge=({config:e,targetWindow:t,unmountNodeCallback:r,mountNodeCallback:s,updateServicesCallback:n,updateAllowedPluginsCallback:i,updateSerializedPropsCollectionCallback:o,updateComponentNodesCollectionCallback:a,injectStylesPreloadsAndPrefetches:c=_e,injectScripts:l=Je,lazyScriptsManager:d})=>{function h(e){return t.document.querySelector(`[data-pathname="${e}"]`)}function u(e,r){const s=v(t.document,"div",{innerHTML:r});return s.setAttribute("data-pathname",e),s}return({pathname:p,data:m})=>{const{htmlString:g,servicesConfig:b,allowedPlugins:f}=m;return n(b),i(f),c({targetWindow:t,webResponse:m,config:e}).then(()=>{const e=h(p);if(!e&&g){const e=u(p,g);return t.document.body.appendChild(e),!0}if(e){if(r(e),!g)return e.parentNode.removeChild(e),!1;const t=u(p,g);return e.parentNode.replaceChild(t,e),!0}return!1}).then(e=>{a(),l({targetWindow:t,webResponse:m,lazyScriptsManager:d,updateSerializedPropsCollectionCallback:o}).then(()=>e&&s(h(p)))})}};const Ke=(e,t="")=>e+t;class Qe{constructor(e,t){this.targetWindow=e,this.observedElements={},this.downloaded=[],this.registered=[],this.dependencyMapCache=[],this.observer=null,this.errorReporter=Ce(e),this.componentNodesFinder=t,this.unhandledClicks={}}createObserverInstance(){const e=this.observerEntriesHandler.bind(this);this.observer=new this.targetWindow.IntersectionObserver(e,{rootMargin:"800px",threshold:0})}markAsDownloaded(e){this.downloaded.push(e)}isDownloaded(e){return this.downloaded.includes(e)}markAsRegistered(e){this.registered.push(e)}isRegistered(e){return this.registered.includes(e)}observeElement(e,t){this.observedElements[t]=[...this.observedElements[t]||[],e],this.observer.observe(e)}unobserveAllUnderKey(e){this.observedElements[e].forEach(e=>this.observer.unobserve(e))}getDependencyMapEntry(e,t=""){return this.dependencyMapCache.find(({prototypeId:r,clientImplementationVersion:s=""})=>r===e&&s===t)}addDependencies(e){e.forEach(e=>{const{prototypeId:t,clientImplementationVersion:r}=e;this.getDependencyMapEntry(t,r)||this.dependencyMapCache.push(e)})}observerEntriesHandler(e){e.forEach(e=>{if(!e.isIntersecting)return;const{target:{dataset:{civ:t,prototypeId:r}}}=e,s=this.getDependencyMapEntry(r,t),n=Ke(r,t);this.isDownloaded(n)||(this.markAsDownloaded(n),this.unobserveAllUnderKey(n),Me(this.targetWindow,s.scripts))})}observeComponents(e){e.forEach(e=>{const{prototypeId:t,clientImplementationVersion:r}=e,s=this.componentNodesFinder.find(t,r);if(!s.length)return void this.errorReporter(Error(`Lazy scripts: DOM reference not found for "${t}@${r}"`));const n=Ke(t,r);s.forEach(e=>{this.observeElement(e,n),this.watchForUnhandledClicks(e,n)})})}filterDownloadedScripts(e){return e.filter(({prototypeId:e,clientImplementationVersion:t})=>!this.isDownloaded(Ke(e,t)))}watchForUnhandledClicks(e,t){e.addEventListener("click",()=>{this.isRegistered(t)||(this.unhandledClicks[t]=(this.unhandledClicks[t]||0)+1)})}onPrototypeRegistered(e,t){const r=Ke(e,t),s=this.unhandledClicks[r];if(this.registered.push(r),!s)return;const n=(({navigator:{connection:e,mozConnection:t,webkitConnection:r}})=>e||t||r)(this.targetWindow),i=n?` Connection: ${n.effectiveType}, ${n.downlink}Mbps`:"";this.errorReporter(Error(`Lazy scripts: ${s} unhandled clicks registered for "${e}@${t}" before its script was downloaded.${i}`))}handleSSRAssets(){const{document:e}=this.targetWindow;var t,s;s=()=>{this.dependencyMapCache=((e,t)=>{const s=h(e,'script[data-config="lazy-scripts-map"]'),n=[];if(!s)return n;try{return r(M(s))}catch(i){return t(Error("Lazy scripts: incorrect dependency map JSON")),n}})(e,this.errorReporter),c(this.dependencyMapCache)||(this.createObserverInstance(),this.observeComponents(this.dependencyMapCache))},"loading"===(t=e).readyState?R(t,"DOMContentLoaded",s):s()}handleSubtreeAssets(e){const r=this.filterDownloadedScripts(e);if(c(r))return;const s=(e=>t(e.reduce((e,t)=>{const{prototypeId:r,clientImplementationVersion:s}=t,n=Ke(r,s),i=e[n];return i?(i.scripts.push(t),e):(e[n]={prototypeId:r,clientImplementationVersion:s,scripts:[t]},e)},{})))(r);this.addDependencies(s),this.observer||this.createObserverInstance(),setTimeout(()=>this.observeComponents(s),0)}}class Ye{constructor(e){this.targetWindow=e,this.collection=[],this.updateNodesCollection()}updateNodesCollection(){this.collection=d(this.targetWindow.document,"div[data-prototype-id]")}find(e,t){return t?this.collection.filter(r=>m(r)===e&&f(r)===t):this.collection.filter(t=>m(t)===e)}}const Ze=new class{constructor(e,t,r){this.targetWindow=e;const s=(e=>V(e).config)(this.targetWindow),n=new j({targetWindow:e}),i=new ve({targetWindow:e,config:s}),o=new ye({targetWindow:e}),a=new ce({targetWindow:e,config:s,cookieMonsterClient:i,boxViewsMarker:o,sendPerformanceMetrics:this.sendPerformanceMetrics.bind(this)}),c=Ce(e),l=new We({targetWindow:e,reportError:c}),d=new Ye(e),h=new Qe(e,d),u=(e=>{const{targetWindow:t,reportError:r,componentNodesFinder:s}=e,n=new pe(t,r),i=new ue(Object.assign({},e,{serializedPropsFinder:n}));return{public:Object.assign({init:me(0,s)},i.createPublicAPI()),private:i.createPrivateAPI()}})({targetWindow:e,services:l,reportError:c,componentNodesFinder:d,registerPrototypeCallback:h.onPrototypeRegistered.bind(h),unmountNodeCallback:o.unmountNode.bind(o),mountNodeCallback:o.markBoxAsRendered.bind(o)}),p=new Ne({reportError:c,allowedPlugins:s.allowedPlugins}),m=new $({appContext:n,analytics:a,updateComponentCallback:u.private.updateComponentCallback,beforeUpdateComponentCallback:u.private.beforeUpdateComponentCallback}),g={config:s,targetWindow:e,unmountNodeCallback:u.private.unmountNode,mountNodeCallback:u.private.mountNode,updateSerializedPropsCollectionCallback:u.private.updateSerializedPropsCollection,updateComponentNodesCollectionCallback:u.private.updateComponentNodesCollection,updateServicesCallback:l.update,updateAllowedPluginsCallback:p.boundUpdateRegistry,lazyScriptsManager:h},b=new F({httpClient:t,reportError:c,boxRenderCallback:Xe(g),fragmentRenderCallback:Ge(g)});this.config=s,this.cookieMonsterClient=i,this.boxViewsMarker=o,this.analytics=a,this.services=l,this.componentAPI=u,this.rawDataListenersRegistry=m,this.opboxWebClient=b,this.plugins=p,this.reportError=c,this.lazyScriptsManager=h,this.navigation=new we({targetWindow:e,opboxWebClient:b,rawDataListenersRegistry:m,reportError:c}),this.edgeClient=new fe({httpClient:r,edgeHost:s.edgeHost,language:s.language}),this.edgeUploadClient=new fe({httpClient:r,edgeHost:s.edgeUploadHost,language:s.language}),this.preferencesClient=new Be({edgeClient:this.edgeClient,localStorage:this.targetWindow.localStorage,reportError:this.reportError}),this.uiTools=(e=>{const t=t=>"string"!=typeof t?null:e.document.querySelector(`a[name="${t}"]`),r=t=>{const r=e.pageYOffset||e.document.documentElement.scrollTop||0;return t?t.getBoundingClientRect().top+r:null};return{getBoxAnchorNode:t,getTopOffset:r,scrollTo(s,{animate:n=!0}={}){const i={duration:n?500:0};if("number"==typeof s)return void ke(e,s,i);const o=t(s);if(o){const t=r(o);ke(e,t,i)}},tween(...t){return xe(e,...t)}}})(e),this.lazyScriptsManager.handleSSRAssets(),this.analytics.initialize(),this.navigation.initialize(),this.boxViewsMarker.initialize()}get API(){return{analytics:this.analytics.createAPI(),boxViewsMarker:this.boxViewsMarker.createAPI(),component:this.componentAPI.public,plugin:this.plugins.createAPI(),onData:this.rawDataListenersRegistry.registerListener.bind(this.rawDataListenersRegistry),changeParams:this.navigation.navigateRelative.bind(this.navigation),refreshPage:this.navigation.refreshPage.bind(this.navigation),tween:this.uiTools.tween,scrollTo:this.uiTools.scrollTo,page:this.opboxWebClient.createAPI(),navigation:this.navigation.createAPI(),edge:this.edgeClient.createAPI(),edgeUpload:this.edgeUploadClient.createAPI(),preferences:this.preferencesClient.createAPI(),onDomReady:this.domReadyHelper.bind(this),loaded:!0,performance:V(this.targetWindow).performance,services:this.services.createAPI(),reportError:this.reportError}}domReadyHelper(e){"loading"===this.targetWindow.document.readyState?this.targetWindow.document.addEventListener("DOMContentLoaded",e):this.targetWindow.setTimeout(e,0)}lazyloadedElement({target:e}={}){const t=p(e,"data-placeholder-for");t&&this.opboxWebClient.render.box({boxId:t,isPlaceholder:!0})}renderBoxForLazyloadedPlaceholders(){Array.from(this.targetWindow.document.querySelectorAll("[data-placeholder-for].lazyloaded"),e=>{const t=p(e,"data-placeholder-for");return this.opboxWebClient.render.box({boxId:t,isPlaceholder:!0})})}broadcastAPILoadEvent(){P(this.targetWindow,"opboxAPILoaded",this.targetWindow.document)}attach(){const t=V(this.targetWindow),r=this.API;var s,i;t&&(function e(t,r,s,...i){if(a(t)&&a(r)){if(!t.__queue__)return;o=t.__queue__,c=r,o.forEach(({args:e,reject:t,resolve:r})=>{const s=((e,t)=>{try{return e(...t)}catch(r){return void console.error(r)}})(c,e);s&&a(s.then)&&a(r)&&a(t)&&s.then(r,t)}),s(r,...i)}else n(t)&&n(r)&&Object.keys(t).forEach(n=>{e(t[n],r[n],s,...i.concat(n))});var o,c}(t,r,(r,...s)=>{return n=this.targetWindow,i=function e(t,r,...s){if(0===s.length)return r;const n=s,i=n.shift();return(t="object"!=typeof t?{}:t)[i]=e(t[i],r,...n),t}(t,r,...s),n.opbox=n.opbox||{},void e(n.opbox,i);var n,i}),s=t,i=Object.keys(r).concat("initialized","config"),k(s,e=>!i.includes(e)),Object.freeze(t)),this.broadcastAPILoadEvent(),this.targetWindow.addEventListener("lazyloaded",this.lazyloadedElement.bind(this)),r.performance.markTimeToInteractive("@allegro/opbox-web-browser")}sendPerformanceMetrics(){this.targetWindow.pinter&&this.targetWindow.pinter.sendUserTimings&&this.targetWindow.pinter.sendUserTimings()}run(){this.attach(),this.renderBoxForLazyloadedPlaceholders()}}(window,T(),T());Ze.run(),Ze.attach.bind(Ze);